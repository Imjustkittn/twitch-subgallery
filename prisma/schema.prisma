generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PhotoStatus {
  ACTIVE
  DELETED
}

enum CommentStatus {
  PENDING
  APPROVED
  REMOVED
}

model BroadcasterToken {
  broadcasterId String   @id
  accessToken   String
  refreshToken  String
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Photo {
  id            String        @id @default(cuid())
  broadcasterId String
  url           String
  title         String?
  description   String?
  status        PhotoStatus   @default(ACTIVE)
  createdAt     DateTime      @default(now())

  tips          PhotoTip[]
  comments      PhotoComment[]

  // one-to-one counter record for aggregate totals
  counters      PhotoCounter?

  @@index([broadcasterId])
}

model PhotoCounter {
  id        String  @id @default(cuid())
  photoId   String  @unique
  totalBits Int     @default(0)
  comments  Int     @default(0)

  // back-reference to Photo (this completes the relation)
  photo     Photo   @relation(fields: [photoId], references: [id])
}

model PhotoTip {
  id            String   @id @default(cuid())
  photoId       String
  transactionId String   @unique
  bits          Int
  viewerId      String?
  opaqueId      String
  createdAt     DateTime @default(now())

  photo         Photo    @relation(fields: [photoId], references: [id])

  @@index([photoId])
}

model PhotoComment {
  id            String        @id @default(cuid())
  photoId       String
  viewerId      String?
  opaqueId      String
  text          String
  status        CommentStatus @default(PENDING)
  transactionId String        @unique
  createdAt     DateTime      @default(now())

  photo         Photo         @relation(fields: [photoId], references: [id])

  @@index([photoId])
}
